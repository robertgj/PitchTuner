#!/bin/sh
#

prog="saInputStreamFile_test"
tmp=/tmp/$$
here=`pwd`
bin=$here/bin

# Sanity checks
if [ $? -ne 0 ]; then echo "Failed pwd"; exit 1; fi
if [ ! -f $bin/$prog ] ; then echo "Didnt find "$prog; exit 2; fi

fail()
{
        echo FAILED $0 $prog 1>&2
        cd $here
        rm -rf $tmp
        exit 1
}

pass()
{
        echo PASSED $0 $prog
        cd $here
        rm -rf $tmp
        exit 0
}

trap "fail" 1 2 3 15
mkdir $tmp
if [ $? -ne 0 ]; then echo "Failed mkdir"; exit 1; fi
cd $tmp
if [ $? -ne 0 ]; then echo "Failed cd"; fail; fi

#
# the input looks like this
#
cat > test.asc << 'EOF'
12345
3
399
 -32767
 -32766
 -32765
 -32764
 -32763
 -32762
 -32761
 -32760
 -32759
 -32758
 -32757
 -32756
 -32755
 -32754
 -32753
 -32752
 -32751
 -32750
 -32749
 -32748
 -32747
 -32746
 -32745
 -32744
 -32743
 -32742
 -32741
 -32740
 -32739
 -32738
 -32737
 -32736
 -32735
 -32734
 -32733
 -32732
 -32731
 -32730
 -32729
 -32728
 -32727
 -32726
 -32725
 -32724
 -32723
 -32722
 -32721
 -32720
 -32719
 -32718
 -32717
 -32716
 -32715
 -32714
 -32713
 -32712
 -32711
 -32710
 -32709
 -32708
 -32707
 -32706
 -32705
 -32704
 -32703
 -32702
 -32701
 -32700
 -32699
 -32698
 -32697
 -32696
 -32695
 -32694
 -32693
 -32692
 -32691
 -32690
 -32689
 -32688
 -32687
 -32686
 -32685
 -32684
 -32683
 -32682
 -32681
 -32680
 -32679
 -32678
 -32677
 -32676
 -32675
 -32674
 -32673
 -32672
 -32671
 -32670
 -32669
 -32668
 -32667
 -32666
 -32665
 -32664
 -32663
 -32662
 -32661
 -32660
 -32659
 -32658
 -32657
 -32656
 -32655
 -32654
 -32653
 -32652
 -32651
 -32650
 -32649
 -32648
 -32647
 -32646
 -32645
 -32644
 -32643
 -32642
 -32641
 -32640
 -32639
 -32638
 -32637
 -32636
 -32635
 -32634
 -32633
 -32632
 -32631
 -32630
 -32629
 -32628
 -32627
 -32626
 -32625
 -32624
 -32623
 -32622
 -32621
 -32620
 -32619
 -32618
 -32617
 -32616
 -32615
 -32614
 -32613
 -32612
 -32611
 -32610
 -32609
 -32608
 -32607
 -32606
 -32605
 -32604
 -32603
 -32602
 -32601
 -32600
 -32599
 -32598
 -32597
 -32596
 -32595
 -32594
 -32593
 -32592
 -32591
 -32590
 -32589
 -32588
 -32587
 -32586
 -32585
 -32584
 -32583
 -32582
 -32581
 -32580
 -32579
 -32578
 -32577
 -32576
 -32575
 -32574
 -32573
 -32572
 -32571
 -32570
 -32569
 -32568
 -32567
 -32566
 -32565
 -32564
 -32563
 -32562
 -32561
 -32560
 -32559
 -32558
 -32557
 -32556
 -32555
 -32554
 -32553
 -32552
 -32551
 -32550
 -32549
 -32548
 -32547
 -32546
 -32545
 -32544
 -32543
 -32542
 -32541
 -32540
 -32539
 -32538
 -32537
 -32536
 -32535
 -32534
 -32533
 -32532
 -32531
 -32530
 -32529
 -32528
 -32527
 -32526
 -32525
 -32524
 -32523
 -32522
 -32521
 -32520
 -32519
 -32518
 -32517
 -32516
 -32515
 -32514
 -32513
 -32512
 -32511
 -32510
 -32509
 -32508
 -32507
 -32506
 -32505
 -32504
 -32503
 -32502
 -32501
 -32500
 -32499
 -32498
 -32497
 -32496
 -32495
 -32494
 -32493
 -32492
 -32491
 -32490
 -32489
 -32488
 -32487
 -32486
 -32485
 -32484
 -32483
 -32482
 -32481
 -32480
 -32479
 -32478
 -32477
 -32476
 -32475
 -32474
 -32473
 -32472
 -32471
 -32470
 -32469
 -32468
 -32467
 -32466
 -32465
 -32464
 -32463
 -32462
 -32461
 -32460
 -32459
 -32458
 -32457
 -32456
 -32455
 -32454
 -32453
 -32452
 -32451
 -32450
 -32449
 -32448
 -32447
 -32446
 -32445
 -32444
 -32443
 -32442
 -32441
 -32440
 -32439
 -32438
 -32437
 -32436
 -32435
 -32434
 -32433
 -32432
 -32431
 -32430
 -32429
 -32428
 -32427
 -32426
 -32425
 -32424
 -32423
 -32422
 -32421
 -32420
 -32419
 -32418
 -32417
 -32416
 -32415
 -32414
 -32413
 -32412
 -32411
 -32410
 -32409
 -32408
 -32407
 -32406
 -32405
 -32404
 -32403
 -32402
 -32401
 -32400
 -32399
 -32398
 -32397
 -32396
 -32395
 -32394
 -32393
 -32392
 -32391
 -32390
 -32389
 -32388
 -32387
 -32386
 -32385
 -32384
 -32383
 -32382
 -32381
 -32380
 -32379
 -32378
 -32377
 -32376
 -32375
 -32374
 -32373
 -32372
 -32371
 -32370
 -32369
 -32368
 -32367
 -32366
 -32365
 -32364
 -32363
 -32362
 -32361
 -32360
 -32359
 -32358
 -32357
 -32356
 -32355
 -32354
 -32353
 -32352
 -32351
 -32350
 -32349
 -32348
 -32347
 -32346
 -32345
 -32344
 -32343
 -32342
 -32341
 -32340
 -32339
 -32338
 -32337
 -32336
 -32335
 -32334
 -32333
 -32332
 -32331
 -32330
 -32329
 -32328
 -32327
 -32326
 -32325
 -32324
 -32323
 -32322
 -32321
 -32320
 -32319
 -32318
 -32317
 -32316
 -32315
 -32314
 -32313
 -32312
 -32311
 -32310
 -32309
 -32308
 -32307
 -32306
 -32305
 -32304
 -32303
 -32302
 -32301
 -32300
 -32299
 -32298
 -32297
 -32296
 -32295
 -32294
 -32293
 -32292
 -32291
 -32290
 -32289
 -32288
 -32287
 -32286
 -32285
 -32284
 -32283
 -32282
 -32281
 -32280
 -32279
 -32278
 -32277
 -32276
 -32275
 -32274
 -32273
 -32272
 -32271
 -32270
 -32269
 -32268
 -32267
 -32266
 -32265
 -32264
 -32263
 -32262
 -32261
 -32260
 -32259
 -32258
 -32257
 -32256
 -32255
 -32254
 -32253
 -32252
 -32251
 -32250
 -32249
 -32248
 -32247
 -32246
 -32245
 -32244
 -32243
 -32242
 -32241
 -32240
 -32239
 -32238
 -32237
 -32236
 -32235
 -32234
 -32233
 -32232
 -32231
 -32230
 -32229
 -32228
 -32227
 -32226
 -32225
 -32224
 -32223
 -32222
 -32221
 -32220
 -32219
 -32218
 -32217
 -32216
 -32215
 -32214
 -32213
 -32212
 -32211
 -32210
 -32209
 -32208
 -32207
 -32206
 -32205
 -32204
 -32203
 -32202
 -32201
 -32200
 -32199
 -32198
 -32197
 -32196
 -32195
 -32194
 -32193
 -32192
 -32191
 -32190
 -32189
 -32188
 -32187
 -32186
 -32185
 -32184
 -32183
 -32182
 -32181
 -32180
 -32179
 -32178
 -32177
 -32176
 -32175
 -32174
 -32173
 -32172
 -32171
 -32170
 -32169
 -32168
 -32167
 -32166
 -32165
 -32164
 -32163
 -32162
 -32161
 -32160
 -32159
 -32158
 -32157
 -32156
 -32155
 -32154
 -32153
 -32152
 -32151
 -32150
 -32149
 -32148
 -32147
 -32146
 -32145
 -32144
 -32143
 -32142
 -32141
 -32140
 -32139
 -32138
 -32137
 -32136
 -32135
 -32134
 -32133
 -32132
 -32131
 -32130
 -32129
 -32128
 -32127
 -32126
 -32125
 -32124
 -32123
 -32122
 -32121
 -32120
 -32119
 -32118
 -32117
 -32116
 -32115
 -32114
 -32113
 -32112
 -32111
 -32110
 -32109
 -32108
 -32107
 -32106
 -32105
 -32104
 -32103
 -32102
 -32101
 -32100
 -32099
 -32098
 -32097
 -32096
 -32095
 -32094
 -32093
 -32092
 -32091
 -32090
 -32089
 -32088
 -32087
 -32086
 -32085
 -32084
 -32083
 -32082
 -32081
 -32080
 -32079
 -32078
 -32077
 -32076
 -32075
 -32074
 -32073
 -32072
 -32071
 -32070
 -32069
 -32068
 -32067
 -32066
 -32065
 -32064
 -32063
 -32062
 -32061
 -32060
 -32059
 -32058
 -32057
 -32056
 -32055
 -32054
 -32053
 -32052
 -32051
 -32050
 -32049
 -32048
 -32047
 -32046
 -32045
 -32044
 -32043
 -32042
 -32041
 -32040
 -32039
 -32038
 -32037
 -32036
 -32035
 -32034
 -32033
 -32032
 -32031
 -32030
 -32029
 -32028
 -32027
 -32026
 -32025
 -32024
 -32023
 -32022
 -32021
 -32020
 -32019
 -32018
 -32017
 -32016
 -32015
 -32014
 -32013
 -32012
 -32011
 -32010
 -32009
 -32008
 -32007
 -32006
 -32005
 -32004
 -32003
 -32002
 -32001
 -32000
 -31999
 -31998
 -31997
 -31996
 -31995
 -31994
 -31993
 -31992
 -31991
 -31990
 -31989
 -31988
 -31987
 -31986
 -31985
 -31984
 -31983
 -31982
 -31981
 -31980
 -31979
 -31978
 -31977
 -31976
 -31975
 -31974
 -31973
 -31972
 -31971
 -31970
 -31969
 -31968
 -31967
 -31966
 -31965
 -31964
 -31963
 -31962
 -31961
 -31960
 -31959
 -31958
 -31957
 -31956
 -31955
 -31954
 -31953
 -31952
 -31951
 -31950
 -31949
 -31948
 -31947
 -31946
 -31945
 -31944
 -31943
 -31942
 -31941
 -31940
 -31939
 -31938
 -31937
 -31936
 -31935
 -31934
 -31933
 -31932
 -31931
 -31930
 -31929
 -31928
 -31927
 -31926
 -31925
 -31924
 -31923
 -31922
 -31921
 -31920
 -31919
 -31918
 -31917
 -31916
 -31915
 -31914
 -31913
 -31912
 -31911
 -31910
 -31909
 -31908
 -31907
 -31906
 -31905
 -31904
 -31903
 -31902
 -31901
 -31900
 -31899
 -31898
 -31897
 -31896
 -31895
 -31894
 -31893
 -31892
 -31891
 -31890
 -31889
 -31888
 -31887
 -31886
 -31885
 -31884
 -31883
 -31882
 -31881
 -31880
 -31879
 -31878
 -31877
 -31876
 -31875
 -31874
 -31873
 -31872
 -31871
 -31870
 -31869
 -31868
 -31867
 -31866
 -31865
 -31864
 -31863
 -31862
 -31861
 -31860
 -31859
 -31858
 -31857
 -31856
 -31855
 -31854
 -31853
 -31852
 -31851
 -31850
 -31849
 -31848
 -31847
 -31846
 -31845
 -31844
 -31843
 -31842
 -31841
 -31840
 -31839
 -31838
 -31837
 -31836
 -31835
 -31834
 -31833
 -31832
 -31831
 -31830
 -31829
 -31828
 -31827
 -31826
 -31825
 -31824
 -31823
 -31822
 -31821
 -31820
 -31819
 -31818
 -31817
 -31816
 -31815
 -31814
 -31813
 -31812
 -31811
 -31810
 -31809
 -31808
 -31807
 -31806
 -31805
 -31804
 -31803
 -31802
 -31801
 -31800
 -31799
 -31798
 -31797
 -31796
 -31795
 -31794
 -31793
 -31792
 -31791
 -31790
 -31789
 -31788
 -31787
 -31786
 -31785
 -31784
 -31783
 -31782
 -31781
 -31780
 -31779
 -31778
 -31777
 -31776
 -31775
 -31774
 -31773
 -31772
 -31771
 -31770
 -31769
 -31768
 -31767
 -31766
 -31765
 -31764
 -31763
 -31762
 -31761
 -31760
 -31759
 -31758
 -31757
 -31756
 -31755
 -31754
 -31753
 -31752
 -31751
 -31750
 -31749
 -31748
 -31747
 -31746
 -31745
 -31744
 -31743
 -31742
 -31741
 -31740
 -31739
 -31738
 -31737
 -31736
 -31735
 -31734
 -31733
 -31732
 -31731
 -31730
 -31729
 -31728
 -31727
 -31726
 -31725
 -31724
 -31723
 -31722
 -31721
 -31720
 -31719
 -31718
 -31717
 -31716
 -31715
 -31714
 -31713
 -31712
 -31711
 -31710
 -31709
 -31708
 -31707
 -31706
 -31705
 -31704
 -31703
 -31702
 -31701
 -31700
 -31699
 -31698
 -31697
 -31696
 -31695
 -31694
 -31693
 -31692
 -31691
 -31690
 -31689
 -31688
 -31687
 -31686
 -31685
 -31684
 -31683
 -31682
 -31681
 -31680
 -31679
 -31678
 -31677
 -31676
 -31675
 -31674
 -31673
 -31672
 -31671
 -31670
 -31669
 -31668
 -31667
 -31666
 -31665
 -31664
 -31663
 -31662
 -31661
 -31660
 -31659
 -31658
 -31657
 -31656
 -31655
 -31654
 -31653
 -31652
 -31651
 -31650
 -31649
 -31648
 -31647
 -31646
 -31645
 -31644
 -31643
 -31642
 -31641
 -31640
 -31639
 -31638
 -31637
 -31636
 -31635
 -31634
 -31633
 -31632
 -31631
 -31630
 -31629
 -31628
 -31627
 -31626
 -31625
 -31624
 -31623
 -31622
 -31621
 -31620
 -31619
 -31618
 -31617
 -31616
 -31615
 -31614
 -31613
 -31612
 -31611
 -31610
 -31609
 -31608
 -31607
 -31606
 -31605
 -31604
 -31603
 -31602
 -31601
 -31600
 -31599
 -31598
 -31597
 -31596
 -31595
 -31594
 -31593
 -31592
 -31591
 -31590
 -31589
 -31588
 -31587
 -31586
 -31585
 -31584
 -31583
 -31582
 -31581
 -31580
 -31579
 -31578
 -31577
 -31576
 -31575
 -31574
 -31573
 -31572
 -31571
EOF
if [ $? -ne 0 ]; then echo "Failed input cat"; fail; fi

#
# the output should look like this
#
cat > test.out << 'EOF'
-32766
-32763
-32760
-32757
-32754
-32751
-32748
-32745
-32742
-32739
-32736
-32733
-32730
-32727
-32724
-32721
-32718
-32715
-32712
-32709
-32706
-32703
-32700
-32697
-32694
-32691
-32688
-32685
-32682
-32679
-32676
-32673
-32670
-32667
-32664
-32661
-32658
-32655
-32652
-32649
-32646
-32643
-32640
-32637
-32634
-32631
-32628
-32625
-32622
-32619
-32616
-32613
-32610
-32607
-32604
-32601
-32598
-32595
-32592
-32589
-32586
-32583
-32580
-32577
-32574
-32571
-32568
-32565
-32562
-32559
-32556
-32553
-32550
-32547
-32544
-32541
-32538
-32535
-32532
-32529
-32526
-32523
-32520
-32517
-32514
-32511
-32508
-32505
-32502
-32499
-32496
-32493
-32490
-32487
-32484
-32481
-32478
-32475
-32472
-32469
-32466
-32463
-32460
-32457
-32454
-32451
-32448
-32445
-32442
-32439
-32436
-32433
-32430
-32427
-32424
-32421
-32418
-32415
-32412
-32409
-32406
-32403
-32400
-32397
-32394
-32391
-32388
-32385
-32382
-32379
-32376
-32373
-32370
-32367
-32364
-32361
-32358
-32355
-32352
-32349
-32346
-32343
-32340
-32337
-32334
-32331
-32328
-32325
-32322
-32319
-32316
-32313
-32310
-32307
-32304
-32301
-32298
-32295
-32292
-32289
-32286
-32283
-32280
-32277
-32274
-32271
-32268
-32265
-32262
-32259
-32256
-32253
-32250
-32247
-32244
-32241
-32238
-32235
-32232
-32229
-32226
-32223
-32220
-32217
-32214
-32211
-32208
-32205
-32202
-32199
-32196
-32193
-32190
-32187
-32184
-32181
-32178
-32175
-32172
-32169
-32166
-32163
-32160
-32157
-32154
-32151
-32148
-32145
-32142
-32139
-32136
-32133
-32130
-32127
-32124
-32121
-32118
-32115
-32112
-32109
-32106
-32103
-32100
-32097
-32094
-32091
-32088
-32085
-32082
-32079
-32076
-32073
-32070
-32067
-32064
-32061
-32058
-32055
-32052
-32049
-32046
-32043
-32040
-32037
-32034
-32031
-32028
-32025
-32022
-32019
-32016
-32013
-32010
-32007
-32004
-32001
-31998
-31995
-31992
-31989
-31986
-31983
-31980
-31977
-31974
-31971
-31968
-31965
-31962
-31959
-31956
-31953
-31950
-31947
-31944
-31941
-31938
-31935
-31932
-31929
-31926
-31923
-31920
-31917
-31914
-31911
-31908
-31905
-31902
-31899
-31896
-31893
-31890
-31887
-31884
-31881
-31878
-31875
-31872
-31869
-31866
-31863
-31860
-31857
-31854
-31851
-31848
-31845
-31842
-31839
-31836
-31833
-31830
-31827
-31824
-31821
-31818
-31815
-31812
-31809
-31806
-31803
-31800
-31797
-31794
-31791
-31788
-31785
-31782
-31779
-31776
-31773
-31770
-31767
-31764
-31761
-31758
-31755
-31752
-31749
-31746
-31743
-31740
-31737
-31734
-31731
-31728
-31725
-31722
-31719
-31716
-31713
-31710
-31707
-31704
-31701
-31698
-31695
-31692
-31689
-31686
-31683
-31680
-31677
-31674
-31671
-31668
-31665
-31662
-31659
-31656
-31653
-31650
-31647
-31644
-31641
-31638
-31635
-31632
-31629
-31626
-31623
-31620
-31617
-31614
-31611
-31608
-31605
-31602
-31599
-31596
-31593
-31590
-31587
-31584
-31581
-31578
-31575
-31572
EOF
if [ $? -ne 0 ]; then echo "Failed output ok cat"; fail; fi

cat > test.txt << 'EOF'
Testing read
Reading 399 frames from test.asc at channel 1
Frames per sec. 12345
Samples per frame 3
Frames per fragment 16384
Frames per stream 399
Test read
EOF
if [ $? -ne 0 ]; then echo "Failed output text cat"; fail; fi


#
# run and see if the results match
#
args="--read_test --channel 1 --frames 399 --file test.asc"
echo "Running $prog $args"
$VALGRIND_CMD $bin/$prog $args > out 2> txt
diff out test.out
if [ $? -ne 0 ]; then echo "Failed diff out"; fail; fi
diff txt test.txt
if [ $? -ne 0 ]; then echo "Failed diff txt"; fail; fi

#
# this much worked
#
pass
